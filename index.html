<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Live HTML in Brackets – JSConf.eu 2013</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/default.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">
        
<!--
        <script src="customjs.js"></script>
-->
        <link rel="stylesheet" href="customcss.css">
        
		<!-- If the query includes 'print-pdf', use the PDF print sheet -->
		<script>
			document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>Building Live HTML and Omnisicent Debuggers</h1>
                    <h3>JSConf.eu 2000</h3>
					<p>
						<small><a href="http://blueskyonmars.com/">Kevin Dangoor, Adobe</a> / <a href="http://twitter.com/dangoor">@dangoor</a>, <a href="https://plus.google.com/+KevinDangoor">+KevinDangoor</a></small>
					</p>
					<p>
						<small><a href="http://blueskyonmars.com/">Peter Flynn, Adobe</a> / <a href="http://twitter.com/knownissues">@knownissues</a></small>
					</p>
				</section>
                
                <section>
                    <h2>Constraining the Problem</h2>
                    <ul>
                        <li>Update the page as the user types</li>
                        <li>Do it quickly</li>
                        <li>Try to replace a reasonably minimal part of the page</li>
                    </ul>
                    
                    <h3 style="margin-top: 1em">How hard can it be?</h3>
                </section>
                
                <section>
                    <h2>HTML (or XML) Diff Research</h2>
                    <p>Daniel Ehrenberg wrote <a href="http://www.scribd.com/doc/14482474/XML-diff-survey">a paper</a> surveying the research:</p>
                    <blockquote>A warning: All of the algorithms are fairly difficult to understand. I don’tunderstand all of them; it took me months to figure out the Zhang-Shasha algorithm.</blockquote>
                </section>
                
                <section>
                    <h2>"BULD" was a Starting Point</h2>
                    <div><cite class="mycite">"Detecting Changes in XML Documents"</cite> by Cobéna and Marian</div>
                    <blockquote>[O]ur algorithm has to be very efficient in terms
of speed and memory space even at the cost of some loss of “quality”. Also, it considers, besides insertions, deletions and updates (standard in diffs), a
move operation on subtrees that is essential in the context of XML.</blockquote>
                </section>
                
                <section>
                    <h2>The Big Difference</h2>
                    <div>We can identify elements thanks to CodeMirror's marks.</div>
                    <img src="marks.png" style="width: 100%">
                </section>
                
                <section>
                    <h2>The Basic Process</h2>
                    <ol>
                        <li>Try to find the affected part of the tree</li>
                        <li>Tokenize the document</li>
                        <li>Generate a list of edits</li>
                        <li>Send the edits to the browser</li>
                        <li>Apply the edits</li>
                    </ol>
                </section>
                
                <section>
                    <h2>Incremental or Full?</h2>
                    <pre><code data-trim>        if (changeList && !changeList.next) {
    if (!isDangerousEdit(changeList.text) && !isDangerousEdit(changeList.removed)) {
        var startMark = _getMarkerAtDocumentPos(editor, changeList.from, true);
        if (startMark) {
            var range = startMark.find();
            if (range) {
                text = editor._codeMirror.getRange(range.from, range.to);
                this.changedTagID = startMark.tagID;
                startOffsetPos = range.from;
                startOffset = editor._codeMirror.indexFromPos(startOffsetPos);
                this.isIncremental = true;
            }
        }
    }
}
</code></pre>
                </section>
                
                <section>
                    <h2>Subtrees</h2>
                    <img style="width: 100%" src="marks.png">
                </section>
                
                <section>
                    <h2>Tokenizing</h2>
                    <div>Based on <a href="https://github.com/fb55/htmlparser2">https://github.com/fb55/htmlparser2</a></div>
                    <ol>
                        <li>Read the tokens, if it's invalid stop updating until it becomes valid</li>
                        <li>As tokens are read, tags are matched up with the marks to assign IDs to them</li>
                        <li>Build a "Simple DOM"</li>
                        <li>Calculate hashes for text nodes, element attributes, child nodes, subtrees</li>
                    </ol>
                </section>
                
                <section>
                    <h2>Hashes</h2>
                    <pre><code data-trim>        update: function () {
            if (this.isElement()) {
                var i,
                    subtreeHashes = "",
                    childHashes = "",
                    child;
                for (i = 0; i &lt; this.children.length; i++) {
                    child = this.children[i];
                    if (child.isElement()) {
                        childHashes += String(child.tagID);
                        subtreeHashes += String(child.tagID) + child.attributeSignature + child.subtreeSignature;
                    } else {
                        childHashes += child.textSignature;
                        subtreeHashes += child.textSignature;
                    }
                }
                this.childSignature = MurmurHash3.hashString(childHashes, childHashes.length, seed);
                this.subtreeSignature = MurmurHash3.hashString(subtreeHashes, subtreeHashes.length, seed);
            } else {
                this.textSignature = MurmurHash3.hashString(this.content, this.content.length, seed);
            }
        },
</code></pre>
                </section>
                
                <section>
                    <h2>Edit Example</h2>
                    <p>
                        Hi, JSConf.
                    </p>
                    <p>
                        <em>What will this do?</em>
                    </p>
                </section>

                <section>
                    <h2>Simple DOM</h2>
                    <center>
                    <table class="simpledom">
                        <tbody>
                            <tr>
                                <td colspan="9" class="element">&lt;section&gt; <span class="tagid">1</span></td>
                            </tr>
                            <tr>
                                <td class="text">"\n&nbsp;"</td>
                                <td class="element">&lt;h2&gt; <span class="tagid">2</span></td>
                                <td class="text">"\n&nbsp;"</td>
                                <td class="element">&lt;p&gt; <span class="tagid">3</span></td>
                                <td class="text">"\n&nbsp;"</td>
                                <td class="element" colspan="3">&lt;p&gt; <span class="tagid">4</span></td>
                                <td class="text">"\n&nbsp;"</td>
                            </tr>
                            <tr>
                                <td>
                                    &nbsp;
                                </td>
                                <td class="text">"Edit Example"</td>
                                <td>&nbsp;</td>
                                <td class="text">"\n       Hi, JSConf.\n     "</td>
                                <td>&nbsp;</td>
                                                                                                   <td class="text">"\n&nbsp;"</td>
                                <td class="element">&lt;em&gt; <span class="tagid">5</span></td>
                                <td class="text">"\n&nbsp;"</td>
                            </tr>
                            <tr>
                                <td colspan="6">&nbsp;</td>
                                <td class="text">"What will this do?"</td>
                            </tr>
                        </tbody>
                    </table>
                    </center>
                </section>
                
                <section>
                    <h2>Simple DOM (Changing)</h2>
                    <center>
                    <table class="simpledom">
                        <tbody>
                            <tr>
                                <td colspan="9" class="element">&lt;section&gt; <span class="tagid">1</span></td>
                            </tr>
                            <tr>
                                <td class="text">"\n&nbsp;"</td>
                                <td class="element">&lt;h2&gt; <span class="tagid">2</span></td>
                                <td class="text">"\n&nbsp;"</td>
                                <td class="element">&lt;p&gt; <span class="tagid">3</span></td>
                                <td class="text">"\n&nbsp;"</td>
                                <td class="element deleting" colspan="3">&lt;p&gt; <span class="tagid">4</span></td>
                                <td class="text">"\n&nbsp;"</td>
                            </tr>
                            <tr>
                                <td>
                                    &nbsp;
                                </td>
                                <td class="text">"Edit Example"</td>
                                <td>&nbsp;</td>
                                <td class="text">"\n       Hi, JSConf.\n     "</td>
                                <td>&nbsp;</td>
                                                                                                   <td class="text">"\n&nbsp;"</td>
                                <td class="element moving">&lt;em&gt; <span class="tagid">5</span></td>
                                <td class="text">"\n&nbsp;"</td>
                            </tr>
                            <tr>
                                <td colspan="6">&nbsp;</td>
                                <td class="text">"What will this do?"</td>
                            </tr>
                        </tbody>
                    </table>
                    </center>
                </section>

                <section>
                    <h2>Simple DOM (New)</h2>
                    <center>
                    <table class="simpledom">
                        <tbody>
                            <tr>
                                <td colspan="9" class="element">&lt;section&gt; <span class="tagid">1</span></td>
                            </tr>
                            <tr>
                                <td class="text">"\n&nbsp;"</td>
                                <td class="element">&lt;h2&gt; <span class="tagid">2</span></td>
                                <td class="text">"\n&nbsp;"</td>
                                <td class="element" colspan="4">&lt;p&gt; <span class="tagid">3</span></td>
                                <td class="text">"\n&nbsp;"</td>
                            </tr>
                            <tr>
                                <td>
                                    &nbsp;
                                </td>
                                <td class="text">"Edit Example"</td>
                                <td>&nbsp;</td>
                                <td class="text">"\n       Hi, JSConf.\n     "</td>
                                <td class="element" colspan="2">&lt;em&gt; <span class="tagid">5</span></td>
                                <td class="text">"\n&nbsp;"</td>
                            </tr>
                            <tr>
                                <td colspan="4">&nbsp;</td>
                                <td class="text" colspan="2">"What will this do?"</td>
                            </tr>
                        </tbody>
                    </table>
                    </center>
                </section>
                
                <section id="example">
                    <h2>Edit Example</h2>
                    <p>
                        Hi, JSConf.
                    </p>
                    <p>
                        <em>What will this do?</em>
                    </p>
                </section>

                <section>
                    <h2>Diff Generation</h2>
                    <div>Generate edits to go from <b>old</b> to <b>new</b>.</div>
                    <ol>
                        <li>Start at the top and work down the new tree</li>
                        <li>Compare attribute hashes</li>
                        <li>Compare child signatures</li>
                        <li>Compare subtree signatures</li>
                        <li>(Or add a new element if the element didn't exist in the old tree)</li>
                    </ol>
                </section>
                
                <section>
                    <h2>Generating Child Edits</h2>
                    <div>You don't want to know.</div>
                </section>
                
                <section>
                    <h2>Generating Child Edits</h2>
                    <div>Gets complicated by:</div>
                    <ul>
                        <li>Text nodes</li>
                        <li>Moves</li>
                    </ul>
                </section>
                
                <section>
<!--
                    <pre><code data-trim="">        // Loop through the current and old children, comparing them one by one.
while (newIndex &lt; newChildren.length && oldIndex &lt; oldChildren.length) {
    newChild = newChildren[newIndex];
    
    // Check to see if the currentChild has been reparented from somewhere 
    // else in the old tree
    if (newChild.children && addElementMove()) {
        continue;
    }
    
    oldChild = oldChildren[oldIndex];
    
    // Check to see if the oldChild has been moved to another parent.
    // If it has, we deal with it on the other side (see above)
    if (hasMoved(oldChild)) {
        oldIndex++;
        continue;
    }
</code></pre>
-->
                    <p>Old</p>
                    <table class="simpledom">
                        <tbody>
                            <tr>
                                <td colspan="9" class="element">&lt;section&gt; <span class="tagid">1</span></td>
                            </tr>
                            <tr>
                                <td class="text">"\n&nbsp;"</td>
                                <td class="element">&lt;h2&gt; <span class="tagid">2</span></td>
                                <td class="text">"\n&nbsp;"</td>
                                <td class="element">&lt;p&gt; <span class="tagid">3</span></td>
                                <td class="text">"\n&nbsp;"</td>
                                <td class="element" colspan="3">&lt;p&gt; <span class="tagid">4</span></td>
                                <td class="text">"\n&nbsp;"</td>
                            </tr>
                            <tr>
                                <td>
                                    &nbsp;
                                </td>
                                <td class="text">"Edit Example"</td>
                                <td>&nbsp;</td>
                                <td class="text">"\n       Hi, JSConf.\n     "</td>
                                <td>&nbsp;</td>
                                                                                                   <td class="text">"\n&nbsp;"</td>
                                <td class="element">&lt;em&gt; <span class="tagid">5</span></td>
                                <td class="text">"\n&nbsp;"</td>
                            </tr>
                            <tr>
                                <td colspan="6">&nbsp;</td>
                                <td class="text">"What will this do?"</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <p>New</p>
                    <table class="simpledom">
                        <tbody>
                            <tr>
                                <td colspan="9" class="element">&lt;section&gt; <span class="tagid">1</span></td>
                            </tr>
                            <tr>
                                <td class="text">"\n&nbsp;"</td>
                                <td class="element">&lt;h2&gt; <span class="tagid">2</span></td>
                                <td class="text">"\n&nbsp;"</td>
                                <td class="element" colspan="4">&lt;p&gt; <span class="tagid">3</span></td>
                                <td class="text">"\n&nbsp;"</td>
                            </tr>
                            <tr>
                                <td>
                                    &nbsp;
                                </td>
                                <td class="text">"Edit Example"</td>
                                <td>&nbsp;</td>
                                <td class="text">"\n       Hi, JSConf.\n     "</td>
                                <td class="element" colspan="2">&lt;em&gt; <span class="tagid">5</span></td>
                                <td class="text">"\n&nbsp;"</td>
                            </tr>
                            <tr>
                                <td colspan="4">&nbsp;</td>
                                <td class="text" colspan="2">"What will this do?"</td>
                            </tr>
                        </tbody>
                    </table>
                </section>
                
                <section>
                    <h2>When you see a difference...</h2>
                    <pre><code data-trim>var addElementInsert = function () {
    if (!oldNodeMap[newChild.tagID]) {
        newEdit = {
            type: "elementInsert",
            tag: newChild.tag,
            tagID: newChild.tagID,
            parentID: newChild.parent.tagID,
            attributes: newChild.attributes
        };
        
        newEdits.push(newEdit);        
        newElements.push(newChild);
        textAfterID = newChild.tagID;
        newIndex++;
        return true;
    }
    return false;
};
</code></pre>
                </section>
                
                <section>
                    <h2>Performance</h2>
                    <div>You know what they say about measurement?</div>
                    <div style="margin-top: 1em">Tokenizing, hash computation, diff generation all seem expensive.</div>
                    <h3 style="margin-top: 0.1em">Nope.</h3>
                </section>
                
                <section>
                    <h2>JavaScript can be slow...</h2>
                    <pre><code>     function generateInstrumentedHTML(doc) {
...
         tags.forEach(function (tag) {
-            var insertIndex = tag.offset + tag.name.length + 1 + insertCount;
-            gen = gen.substr(0, insertIndex) + attrText + gen.substr(insertIndex);
-            insertCount += attrText.length;
+            var insertIndex = tag.offset + tag.name.length + 1;
+            gen += orig.substr(lastIndex, insertIndex - lastIndex) + attrText;
+            lastIndex = insertIndex;
</code></pre>
                </section>
                
                <section>
                    <h2>Sometimes with good reason</h2>
                    <img src="marks.png" style="width: 100%">
                    <div>Calculating mark positions overwhelmed everything else.</div>
                </section>
                
                <section>
                    <h2>Read More</h2>
                    
                    <div><a href="https://github.com/adobe/brackets/wiki/Research:-HTML-DOM-Data-Structure">https://github.com/adobe/brackets/wiki/Research:-HTML-DOM-Data-Structure</a></div>
                </section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

	</body>
</html>
